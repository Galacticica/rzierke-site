<!--
file: song_detail.html
Author: Reagan Zierke
Date: 2026-02-05
Description: Template for song detail view.
-->

{% extends "base.html" %}
{% load static %}
{% load lyric_cleaner %}


{% block title %}
<title>{{ song.title }}</title>
{% endblock %}

{% block content %}
<div class="container mx-auto max-w-6xl px-4 py-8 song-detail">

    <div class="flex items-center justify-between">
        <a
            href="{% url 'song-list' %}"
            class="btn btn-ghost btn-sm"
            onclick="if (window.history.length > 1) { event.preventDefault(); window.history.back(); }"
        >← Back</a>
    </div>

    <div class="mt-4 flex flex-wrap items-start justify-between gap-3 song-header">
        <div>
            <h1 class="text-3xl font-bold tracking-tight md:text-4xl">{{ song.title }}</h1>
            {% with artists=song.artist.all %}
                {% if artists %}
                    <p class="mt-1 text-base-content/70">
                        by {% for artist in artists %}<a class="link" href="{% url 'song-list' %}?artist={{ artist.pk }}" title="View all songs by {{ artist.name }}">{{ artist.name }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}
                    </p>
                {% endif %}
            {% endwith %}

            <div class="mt-3 flex flex-wrap gap-2">
                {% if song.lsb_number %}
                    <span class="badge badge-outline">LSB {{ song.lsb_number }}</span>
                {% endif %}
                {% if song.ccli_number %}
                    <span class="badge badge-outline">CCLI {{ song.ccli_number }}</span>
                {% endif %}
            </div>
        </div>

        <div class="flex gap-2 song-actions">
            <a href="{% url 'song-export-handout-pdf' song.slug %}" class="btn btn-soft btn-secondary">Download PDF</a>
            <a href="{% url 'song-export-pptx' slug=song.slug %}" class="btn btn-soft btn-primary">Export Slides</a>
        </div>
    </div>

    <div class="mt-8 grid gap-6 lg:grid-cols-12 song-layout">
        <aside class="lg:col-span-4 song-sidebar">
            <div class="card border border-base-300 bg-base-100 shadow-sm">
                <div class="card-body gap-4">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title text-base">Details</h2>
                    </div>

                    <div class="stats stats-vertical bg-base-200/50">
                        <div class="stat">
                            <div class="stat-title">Artists</div>
                            <div class="stat-value text-base font-semibold">
                                {% with artists=song.artist.all %}
                                    {% if artists %}
                                        {% for artist in artists %}<a class="link" href="{% url 'song-list' %}?artist={{ artist.pk }}" title="View all songs by {{ artist.name }}">{{ artist.name }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}
                                    {% else %}
                                        <span class="opacity-70">—</span>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                        <div class="stat">
                            
                            <div class="stat-value text-base font-semibold">
                                {% if song.lsb_number or song.ccli_number %}
                                    <div class="flex flex-wrap gap-2">
                                        {% if song.lsb_number %}<span class="badge badge-neutral">LSB {{ song.lsb_number }}</span>{% endif %}
                                        {% if song.ccli_number %}<span class="badge badge-neutral">CCLI {{ song.ccli_number }}</span>{% endif %}
                                    </div>
                                {% else %}
                                    <span class="opacity-70">—</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="stat">
                            <div class="stat-title">Tags</div>
                            <div class="stat-value text-base font-semibold">
                                <div class="flex flex-wrap gap-2">
                                    {% for tag in song.tag.all %}
                                        <a
                                            class="badge badge-primary badge-outline"
                                            href="{% url 'song-list' %}?tag={{ tag.pk }}"
                                            title="View all songs tagged '{{ tag.name }}'">
                                            {{ tag.name }}
                                        </a>
                                    {% empty %}
                                        <span class="opacity-70">—</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <section class="lg:col-span-8 song-content">
            <div class="card border border-base-300 bg-base-100 shadow-sm">
                <div class="card-body">
                    <div class="flex items-center justify-between gap-3">
                        <h2 class="card-title">Lyrics</h2>
                    </div>

                    <div class="mt-2 space-y-3 song-lyrics">
                        {% if song.arrangement_items.all %}
                            {% for item in song.arrangement_items.all %}
                                <div class="collapse collapse-arrow border border-base-300 bg-base-200/40" id="section-{{ item.section.name|default:item.section.get_section_type_display|slugify }}">
                                    <input type="checkbox" checked />
                                    <div class="collapse-title text-base font-semibold">
                                        <span>{{ item.section.name|default:item.section.get_section_type_display }}</span>
                                        {% if item.repeat_count|default:1|add:0 > 1 %}
                                            <span class="ml-2 badge badge-outline">{{ item.repeat_count }}x</span>
                                        {% endif %}
                                    </div>
                                    <div class="collapse-content">
                                        <div class="prose prose-invert max-w-none">
                                            {{ item.section.lyrics|lyrics_html }}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            {% for section in song.sections.all %}
                                <div class="collapse collapse-arrow border border-base-300 bg-base-200/40" id="section-{{ section.name|default:section.get_section_type_display|slugify }}">
                                    <input type="checkbox" checked />
                                    <div class="collapse-title text-base font-semibold">
                                        {{ section.name|default:section.get_section_type_display }}
                                    </div>
                                    <div class="collapse-content">
                                        <div class="prose prose-invert max-w-none">
                                            {{ section.lyrics|lyrics_html }}
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="alert">
                                    <span><em>No lyrics available.</em></span>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

{% endblock %}