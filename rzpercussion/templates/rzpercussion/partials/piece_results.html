<!--
file: piece_results.html
Author: Reagan Zierke
Date: 2026-02-07
Description: Template for piece results section. This partial is intended to be included via HTMX.
-->

{# HTMX fragment: replaces #piece-results #}

<div id="piece-results" class="card border border-base-300 bg-base-100 shadow-sm">
    <div class="card-body">
        <div class="flex items-center justify-between gap-3">
            <h2 class="card-title">All pieces</h2>

            <div class="text-sm opacity-70">
                {% if page_obj.object_list %}
                    {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ filtered_count|default:0 }}
                {% else %}
                    0
                {% endif %}
                item{{ filtered_count|default:0|pluralize }}
            </div>
        </div>

        <span id="matching-count" hx-swap-oob="innerHTML">{{ filtered_count|default:0 }}</span>

        <!-- piece list -->
        <div class="mt-4 space-y-3">
            {% for piece in page_obj.object_list %}
                <div class="block rounded-2xl border border-base-300 bg-base-200/40 p-4 transition hover:bg-base-200/60 hover:border-base-300/80">
                    <div class="flex flex-wrap items-start justify-between gap-3">
                        <div class="min-w-0">
                            <div class="flex items-center gap-2">
                                <h3 class="text-lg font-semibold truncate">
                                    <a class="link" href="{% url 'piece-detail' slug=piece.slug %}">{{ piece.title }}</a>
                                </h3>
                            </div>

                            <!-- composer and artist -->
                            <p class="mt-1 text-sm text-base-content/70">
                                by {{ piece.composer }}
                                {% with performers=piece.performer.all %}
                                    {% if performers %}
                                        | 
                                        {% for performer in performers %}
                                            {{ performer.name }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endwith %}
                            </p>

                            <!-- piece type -->
                            <div class="mt-3 flex flex-wrap gap-2">
                                {% if piece.piece_type %}
                                    <a
                                        class="badge badge-primary badge-outline"
                                        href="{% url 'pieces-list' %}?piece_type={{ piece.piece_type.pk }}"
                                        hx-get="{% url 'pieces-list' %}?piece_type={{ piece.piece_type.pk }}"
                                        hx-target="#piece-layout"
                                        hx-swap="outerHTML"
                                        hx-push-url="true"
                                        title="Filter by piece type '{{ piece.piece_type.name }}'">
                                        {{ piece.piece_type.name }}
                                    </a>
                                {% else %}
                                    <span class="text-xs opacity-60">No type</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- open link -->
                        <div class="flex flex-col items-end gap-2">
                            <a class="text-xs opacity-70 link" href="{% url 'piece-detail' slug=piece.slug %}">Open →</a>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="alert">
                    <span><em>No pieces found.</em></span>
                </div>
            {% endfor %}
        </div>

        <!-- pagination -->
        {% if page_obj.has_other_pages %}
            <div class="mt-6 flex justify-center">
                <div class="join">
                    <!-- Previous page -->
                    {% if page_obj.has_previous %}
                        <a
                            class="btn btn-sm join-item"
                            href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}"
                            hx-get="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}"
                            hx-target="#piece-results"
                            hx-swap="outerHTML"
                            hx-include="#piece-filter-form"
                            hx-push-url="true">
                            ←
                        </a>
                    {% else %}
                        <button class="btn btn-sm btn-disabled join-item">←</button>
                    {% endif %}

                    <!-- Page numbers -->
                    {% for page_num in page_obj.paginator.page_range %}
                        {% if page_num == page_obj.number %}
                            <button class="btn btn-sm join-item btn-active">{{ page_num }}</button>
                        {% elif page_num >= page_obj.number|add:'-2' and page_num <= page_obj.number|add:'2' or page_num == 1 or page_num == page_obj.paginator.num_pages %}
                            <a
                                class="btn btn-sm join-item"
                                href="?page={{ page_num }}{% if q %}&q={{ q }}{% endif %}"
                                hx-get="?page={{ page_num }}{% if q %}&q={{ q }}{% endif %}"
                                hx-target="#piece-results"
                                hx-swap="outerHTML"
                                hx-include="#piece-filter-form"
                                hx-push-url="true">
                                {{ page_num }}
                            </a>
                        {% elif page_num == page_obj.number|add:'-3' or page_num == page_obj.number|add:'3' %}
                            <button class="btn btn-sm btn-disabled join-item">...</button>
                        {% endif %}
                    {% endfor %}

                    <!-- Next page -->
                    {% if page_obj.has_next %}
                        <a
                            class="btn btn-sm join-item"
                            href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}"
                            hx-get="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}"
                            hx-target="#piece-results"
                            hx-swap="outerHTML"
                            hx-include="#piece-filter-form"
                            hx-push-url="true">
                            →
                        </a>
                    {% else %}
                        <button class="btn btn-sm btn-disabled join-item">→</button>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
